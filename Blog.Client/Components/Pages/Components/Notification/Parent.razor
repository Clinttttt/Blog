@page "/notification"
@using static Blog.Client.State.NotificationState
@using static Blog.Application.Queries.Notification.GetListNotification.GetListNotificationQuery




<div class="h-screen overflow-auto bg-gradient-to-br from-slate-50 to-slate-100 overflow-auto p-0 sm:p-5">
    <div class="max-w-4xl mx-auto px-4 py-8 -mb-10">


        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-2">Notifications</h1>
                    <p class="text-slate-600">Stay updated with your latest activities</p>
                </div>
                @if (list?.Any() == true)
                {
                    <div class="flex flex-row gap-1">
                        <button @onclick="() => MarkAllNotificationAsRead()" class="hidden sm:flex items-center gap-2 px-4 py-2 cursor-pointer text-sm text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Mark all as read
                        </button>
                        <button @onclick="() => DeleteAllNotification()" class="hidden sm:flex items-center gap-2 px-4 py-2 cursor-pointer text-sm text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Delete all notification
                        </button>
                    </div>
                }
            </div>
        </div>


        <div class="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
            <button @onclick="() => LoadNotif(NotificationState.ViewState.All)"
                    disabled="@isLoading"
                    class="cursor-pointer px-5 py-2.5 @(NotifState == NotificationState.ViewState.All ? "bg-indigo-600 text-white" : "bg-white text-slate-700 border border-slate-200") rounded-xl font-medium whitespace-nowrap  transition-all shadow-sm hover:shadow disabled:opacity-50 disabled:cursor-not-allowed">
                All
            </button>
            <button @onclick="() => LoadNotif(NotificationState.ViewState.Unread)"
                    disabled="@isLoading"
                    class="cursor-pointer px-5 py-2.5 @(NotifState == NotificationState.ViewState.Unread ? "bg-indigo-600 text-white" : "bg-white text-slate-700 border border-slate-200") rounded-xl font-medium whitespace-nowrap  transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Unread
            </button>
            <button @onclick="() => LoadNotif(NotificationState.ViewState.Posts)"
                    disabled="@isLoading"
                    class="cursor-pointer px-5 py-2.5 @(NotifState == NotificationState.ViewState.Posts ? "bg-indigo-600 text-white" : "bg-white text-slate-700 border border-slate-200") rounded-xl font-medium whitespace-nowrap  transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Posts
            </button>
            <button @onclick="() => LoadNotif(NotificationState.ViewState.Comments)"
                    disabled="@isLoading"
                    class="cursor-pointer px-5 py-2.5 @(NotifState == NotificationState.ViewState.Comments ? "bg-indigo-600 text-white" : "bg-white text-slate-700 border border-slate-200") rounded-xl font-medium whitespace-nowrap  transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Comments
            </button>
        </div>

        @if (isLoading && (list == null || !list.Any()))
        {

            <div class="space-y-4">
                @for (int i = 0; i < 3; i++)
                {
                    <div class="bg-white rounded-xl p-4 animate-pulse">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-slate-200 rounded-full"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                                <div class="h-3 bg-slate-200 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <AllNotification list="@list"
                             ListNotif="@ListNotif"
                             pagination="@pagination"
                             HasMorePost="@HasMorePost"
                             isLoadingMore="@isLoadingMore"
                             LoadMorePosts="@LoadMorePosts"
                             MarkAsRead="@MarkAsRead"
                             DeleteNotification="@DeleteNotification" />
        }

    </div>
</div>

@code {

    private PagedResult<GetListNotificationDto> ListNotif { get; set; } = new PagedResult<GetListNotificationDto>();
    private ListPaginatedRequest pagination { get; set; } = new ListPaginatedRequest { PageNumber = 1, PageSize = 5 };
    private List<GetListNotificationDto>? list;

    private bool HasMorePost = false;
    private bool HasNextPage => pagination.PageNumber < ListNotif.TotalPages;
    private bool isLoadingMore = false;
    private bool isLoading = false;

    public ViewState NotifState { get; set; } = NotificationState.ViewState.All;
    private UserProfileDto? user { get; set; } = new UserProfileDto();
   
        private bool _isInitialized = false;

        protected override async Task OnInitializedAsync()
        {
            await LoadNotif(NotifState);

            if (!_isInitialized)
            {
                try
                {
                    await NotificationSignalR.NotificationInitializeAsync();
                    _isInitialized = true;

                    var UserIdString = await AuthStateProvider.GetUserIdAsync();
                    Guid.TryParse(UserIdString, out var UserId);

                    NotificationSignalR.OnNotification(async (notification) =>
                    {
                        if (notification.RecipientUserId == UserId)
                        {
                            if (list != null)
                            {
                                var newNotification = new GetListNotificationDto
                            {
                                PostId = notification.PostId,
                                Type = notification.Type,
                                CreatedAt = notification.CreatedAt,
                                UserName = notification.ActorName,
                                IsRead = false
                            };

                                list.Insert(0, newNotification);
                                await InvokeAsync(StateHasChanged);
                            }
                        }
                    });
                }
                catch (ObjectDisposedException)
                {
                  
                    Console.WriteLine("Hub was disposed during initialization");
                }
        }
    }




    private async Task MarkAsRead((int Id, int? PostId) data)
    {
        await NotificationClient.MarkNotificationAsRead(data.Id);
        Navigation.NavigateTo($"/viewblogconstruct/{data.PostId}");
        StateHasChanged();
    }

    private async Task MarkAllNotificationAsRead()
    {
        await NotificationClient.MarkAllNotificationAsRead();
        await LoadNotif(NotifState);
        StateHasChanged();
    }

    private async Task DeleteAllNotification()
    {
        await NotificationClient.DeleteAllNotification();

        pagination.PageNumber = 1;
        HasMorePost = false;
        list = new List<GetListNotificationDto>();
        ListNotif = new PagedResult<GetListNotificationDto>();

        await LoadNotif(NotifState);
        StateHasChanged();
    }

    private async Task LoadNotif(NotificationState.ViewState request)
    {

        isLoading = true;

        bool isFilterChange = NotifState != request;

        var tempList = list;


        if (isFilterChange)
        {
            pagination.PageNumber = 1;
        }

        NotifState = request;


        var notifType = request switch
        {
            NotificationState.ViewState.All => NotifType.All,
            NotificationState.ViewState.Comments => NotifType.Comments,
            NotificationState.ViewState.Unread => NotifType.Unread,
            NotificationState.ViewState.Posts => NotifType.Posts,
            _ => NotifType.All
        };

        var notification = await NotificationClient.GetListNotification(pagination, notifType);

        if (notification == null || notification.Value?.Items == null || !notification.Value.Items.Any())
        {
            list = new List<GetListNotificationDto>();
            ListNotif = new PagedResult<GetListNotificationDto>
            {
                Items = list,
                PageNumber = pagination.PageNumber,
                PageSize = pagination.PageSize,
                TotalCount = 0,

            };
            HasMorePost = false;
            isLoading = false;
            StateHasChanged();
            return;
        }

        ListNotif = notification.Value;


        if (pagination.PageNumber == 1 || isFilterChange)
        {
            list = ListNotif.Items.ToList();
        }
        else
        {

            list ??= new();
            list.AddRange(ListNotif.Items);
        }


        HasMorePost = pagination.PageNumber < ListNotif.TotalPages;
        isLoading = false;
        StateHasChanged();
    }

    private async Task DeleteNotification(int notificationId)
    {
        await NotificationClient.DeleteNotification(notificationId);

        var tempPageNumber = pagination.PageNumber;
        pagination.PageNumber = 1;
        list = new List<GetListNotificationDto>();


        for (int i = 1; i <= tempPageNumber; i++)
        {
            pagination.PageNumber = i;
            await LoadNotif(NotifState);
        }

        StateHasChanged();
    }

    private async Task LoadMorePosts()
    {
        if (!HasMorePost || isLoadingMore)
            return;

        isLoadingMore = true;
        pagination.PageNumber++;
        await LoadNotif(NotifState);
        isLoadingMore = false;
    }

}
